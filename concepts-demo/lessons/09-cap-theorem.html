<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAP Theorem | System Design Mastery</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/main.css">
    <style>
        .cap-container {
            display: flex;
            gap: 2rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .cap-triangle {
            width: 320px;
            height: 280px;
        }

        .cap-node {
            fill: var(--bg-tertiary);
            stroke: var(--border-light);
            stroke-width: 3;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cap-node:hover {
            stroke: var(--accent-primary);
        }

        .cap-node.selected {
            fill: url(#capGrad);
            stroke: var(--accent-primary);
        }

        .cap-label {
            fill: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            text-anchor: middle;
            pointer-events: none;
        }

        .cap-info {
            flex: 1;
            min-width: 280px;
        }

        .cap-examples {
            margin-top: 1rem;
        }

        .cap-example {
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .partition-demo {
            display: flex;
            gap: 2rem;
            padding: 1.5rem;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .region {
            padding: 1.5rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-xl);
            text-align: center;
            min-width: 150px;
        }

        .region-nodes {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 0.5rem;
        }

        .mini-node {
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border: 2px solid var(--success);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .partition-line {
            height: 4px;
            width: 80px;
            background: var(--error);
            border-radius: 2px;
            position: relative;
        }

        .partition-line::after {
            content: '‚úï';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--error);
            font-size: 1.2rem;
        }

        .partition-line.connected {
            background: var(--success);
        }

        .partition-line.connected::after {
            content: '‚úì';
            color: var(--success);
        }
    </style>
</head>

<body>
    <div class="bg-pattern"></div>
    <div class="bg-grid"></div>
    <nav class="nav">
        <div class="container nav-content"><a href="../index.html" class="nav-logo">System Design Mastery</a></div>
    </nav>

    <div class="lesson-container">
        <div class="container">
            <header class="lesson-header">
                <div class="lesson-meta"><span class="lesson-number">üìê</span><span class="tag">Module 9</span></div>
                <h1>CAP Theorem</h1>
                <p style="color: var(--text-secondary); max-width: 700px;">In a distributed system experiencing a
                    network partition, you must choose between consistency and availability. You cannot have both.</p>
            </header>

            <div class="lesson-content">
                <section class="lesson-section">
                    <h3>The Three Properties</h3>
                    <div class="concept-grid">
                        <div class="concept-card glass-card">
                            <div class="concept-icon">üéØ</div>
                            <h4>Consistency</h4>
                            <p>All nodes see the same data at the same time. Every read returns the most recent write.
                            </p>
                        </div>
                        <div class="concept-card glass-card">
                            <div class="concept-icon">‚úÖ</div>
                            <h4>Availability</h4>
                            <p>Every request receives a response (success or failure). No request is ignored.</p>
                        </div>
                        <div class="concept-card glass-card">
                            <div class="concept-icon">üîå</div>
                            <h4>Partition Tolerance</h4>
                            <p>System continues operating despite network failures between nodes.</p>
                        </div>
                    </div>
                </section>

                <section class="lesson-section">
                    <h3>Interactive CAP Triangle</h3>
                    <p>Click any <strong>two</strong> properties to see what you get and what you sacrifice.</p>
                    <div class="demo-container">
                        <div class="demo-body">
                            <div class="cap-container">
                                <svg class="cap-triangle" viewBox="0 0 320 280">
                                    <defs>
                                        <linearGradient id="capGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#6366f1" />
                                            <stop offset="100%" style="stop-color:#8b5cf6" />
                                        </linearGradient>
                                    </defs>
                                    <polygon points="160,30 290,240 30,240" fill="rgba(99,102,241,0.1)"
                                        stroke="rgba(99,102,241,0.3)" stroke-width="2" />
                                    <!-- Connection Lines to Labels -->
                                    <line x1="160" y1="40" x2="160" y2="10" stroke="var(--text-muted)" stroke-width="1"
                                        stroke-dasharray="4" />
                                    <line x1="40" y1="230" x2="10" y2="260" stroke="var(--text-muted)" stroke-width="1"
                                        stroke-dasharray="4" />
                                    <line x1="280" y1="230" x2="310" y2="260" stroke="var(--text-muted)"
                                        stroke-width="1" stroke-dasharray="4" />

                                    <circle class="cap-node" data-cap="C" cx="160" cy="40" r="30"
                                        onclick="toggleCAP('C')" />
                                    <circle class="cap-node" data-cap="A" cx="40" cy="230" r="30"
                                        onclick="toggleCAP('A')" />
                                    <circle class="cap-node" data-cap="P" cx="280" cy="230" r="30"
                                        onclick="toggleCAP('P')" />
                                    <text x="160" y="47" class="cap-label">C</text>
                                    <text x="40" y="237" class="cap-label">A</text>
                                    <text x="280" y="237" class="cap-label">P</text>
                                </svg>
                                <div class="cap-info">
                                    <h4 id="capTitle">Select 2 properties</h4>
                                    <p id="capDesc">Click on two nodes to see the trade-off and real-world examples.</p>
                                    <div class="cap-examples" id="capExamples"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="lesson-section">
                    <h3>Network Partition Scenario</h3>
                    <p>Toggle the partition to see how CP and AP systems behave differently.</p>
                    <div class="demo-container">
                        <div class="demo-body">
                            <div class="controls">
                                <button class="btn btn-primary" onclick="togglePartition()">Toggle Network
                                    Partition</button>
                            </div>
                            <div class="partition-demo">
                                <div class="region" onclick="simulateRequest('A')"><strong>Region A</strong>
                                    <div class="region-nodes">
                                        <div class="mini-node" id="n1">N1</div>
                                        <div class="mini-node" id="n2">N2</div>
                                    </div>
                                    <div class="request-feedback" id="feedbackA">Click to write</div>
                                </div>
                                <div class="partition-line connected" id="partitionLine"></div>
                                <div class="region" onclick="simulateRequest('B')"><strong>Region B</strong>
                                    <div class="region-nodes">
                                        <div class="mini-node" id="n3">N3</div>
                                        <div class="mini-node" id="n4">N4</div>
                                    </div>
                                    <div class="request-feedback" id="feedbackB">Click to write</div>
                                </div>
                            </div>
                            <div id="partitionBehavior"
                                style="margin-top: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                                <strong>No partition:</strong> All nodes communicate normally. Both consistency and
                                availability are achievable.
                            </div>
                        </div>
                    </div>
                </section>

                <section class="lesson-section">
                    <h3>Real-World Trade-offs</h3>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>System</th>
                                <th>Choice</th>
                                <th>Behavior During Partition</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Traditional RDBMS</td>
                                <td>CA (no partition tolerance)</td>
                                <td>Single node, doesn't handle partitions</td>
                            </tr>
                            <tr>
                                <td>MongoDB, HBase</td>
                                <td>CP</td>
                                <td>Refuses writes if can't reach majority</td>
                            </tr>
                            <tr>
                                <td>Cassandra, DynamoDB</td>
                                <td>AP</td>
                                <td>Continues serving, resolves conflicts later</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="info-box info">
                        <div class="info-box-title">Modern Reality</div>
                        <p>In practice, partitions are rare but inevitable. Most systems are tunable ‚Äî you choose
                            consistency level per operation. CAP is more of a spectrum than a binary choice.</p>
                    </div>
                </section>

                <!-- PACELC -->
                <section class="lesson-section">
                    <h3>PACELC: Beyond CAP</h3>
                    <p>CAP only applies during partitions. PACELC extends it: "If Partition, choose A/C; Else, choose
                        L/C."</p>
                    <div class="pacelc-visual">
                        <div class="pacelc-stage">
                            <div class="pacelc-condition">Partition?</div>
                            <div class="pacelc-branches">
                                <div class="pacelc-branch yes">
                                    <div class="branch-label">Yes (P)</div>
                                    <div class="pacelc-choice">
                                        <div class="choice-box availability">Availability (A)</div>
                                        <div class="choice-or">OR</div>
                                        <div class="choice-box consistency">Consistency (C)</div>
                                    </div>
                                </div>
                                <div class="pacelc-branch no">
                                    <div class="branch-label">No (Else)</div>
                                    <div class="pacelc-choice">
                                        <div class="choice-box latency">Latency (L)</div>
                                        <div class="choice-or">OR</div>
                                        <div class="choice-box consistency">Consistency (C)</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <style>
                        .pacelc-visual {
                            display: flex;
                            justify-content: center;
                            padding: 2rem;
                            background: var(--bg-secondary);
                            border-radius: var(--radius-lg);
                            margin: 1rem 0;
                        }

                        .pacelc-stage {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            gap: 2rem;
                        }

                        .pacelc-condition {
                            background: var(--bg-tertiary);
                            border: 2px solid var(--accent-primary);
                            padding: 0.75rem 2rem;
                            border-radius: 50px;
                            font-weight: 700;
                            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
                        }

                        .pacelc-branches {
                            display: flex;
                            gap: 3rem;
                        }

                        .pacelc-branch {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            position: relative;
                        }

                        .pacelc-branch::before {
                            content: '';
                            position: absolute;
                            top: -2rem;
                            width: 2px;
                            height: 2rem;
                            background: var(--border-light);
                        }

                        .pacelc-branch.yes::before {
                            left: 50%;
                            transform: skewX(20deg);
                            height: 2.2rem;
                            top: -2.2rem;
                        }

                        .pacelc-branch.no::before {
                            left: 50%;
                            transform: skewX(-20deg);
                            height: 2.2rem;
                            top: -2.2rem;
                        }

                        .branch-label {
                            font-size: 0.8rem;
                            color: var(--text-muted);
                            margin-bottom: 0.5rem;
                        }

                        .pacelc-choice {
                            display: flex;
                            flex-direction: column;
                            gap: 0.5rem;
                            align-items: center;
                        }

                        .choice-box {
                            padding: 0.5rem 1rem;
                            border-radius: var(--radius-md);
                            font-size: 0.9rem;
                            font-weight: 600;
                            width: 140px;
                            text-align: center;
                        }

                        .choice-box.availability {
                            background: rgba(16, 185, 129, 0.1);
                            color: var(--success);
                            border: 1px solid var(--success);
                        }

                        .choice-box.consistency {
                            background: rgba(99, 102, 241, 0.1);
                            color: var(--accent-primary);
                            border: 1px solid var(--accent-primary);
                        }

                        .choice-box.latency {
                            background: rgba(245, 158, 11, 0.1);
                            color: var(--warning);
                            border: 1px solid var(--warning);
                        }

                        .choice-or {
                            font-size: 0.7rem;
                            color: var(--text-muted);
                        }

                        .region {
                            cursor: pointer;
                            transition: transform 0.2s;
                            position: relative;
                        }

                        .region:hover {
                            transform: translateY(-2px);
                        }

                        .request-feedback {
                            font-size: 0.75rem;
                            margin-top: 0.5rem;
                            color: var(--text-muted);
                            height: 1.2em;
                        }
                    </style>
                    <table class="comparison-table" style="margin-top: 1rem;">
                        <thead>
                            <tr>
                                <th>System</th>
                                <th>PACELC Classification</th>
                                <th>Meaning</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>DynamoDB</strong></td>
                                <td>PA/EL</td>
                                <td>Available during partition, low latency normally</td>
                            </tr>
                            <tr>
                                <td><strong>MongoDB</strong></td>
                                <td>PA/EC</td>
                                <td>Available during partition, consistent normally</td>
                            </tr>
                            <tr>
                                <td><strong>Cassandra</strong></td>
                                <td>PA/EL</td>
                                <td>Tunable, defaults to availability and latency</td>
                            </tr>
                            <tr>
                                <td><strong>Spanner</strong></td>
                                <td>PC/EC</td>
                                <td>Consistent always (TrueTime magic)</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- Quiz -->
                <section class="lesson-section">
                    <h3>Check Your Understanding</h3>
                    <div class="quiz-container">
                        <p class="quiz-question">
                            Your distributed shopping cart must always be writable, even during network issues.
                            Occasional stale reads are acceptable. Which CAP trade-off?
                        </p>
                        <div class="quiz-options" id="capQuizOptions">
                            <div class="quiz-option" onclick="checkCAPQuizAnswer(this, false)">CP ‚Äî consistency is king
                            </div>
                            <div class="quiz-option" onclick="checkCAPQuizAnswer(this, true)">AP ‚Äî availability over
                                consistency</div>
                            <div class="quiz-option" onclick="checkCAPQuizAnswer(this, false)">CA ‚Äî ignore network
                                partitions</div>
                            <div class="quiz-option" onclick="checkCAPQuizAnswer(this, false)">None ‚Äî you can have all
                                three</div>
                        </div>
                        <div id="capQuizFeedback" style="margin-top: 1rem; display: none;"></div>
                    </div>
                </section>

                <div class="lesson-nav">
                    <a href="08-sql-nosql.html" class="nav-btn">‚Üê SQL vs NoSQL</a>
                    <a href="10-consistent-hashing.html" class="nav-btn">Consistent Hashing ‚Üí</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const selected = new Set();
        const examples = {
            'CA': ['Traditional RDBMS', 'Single-node systems'],
            'CP': ['MongoDB', 'HBase', 'Redis Cluster'],
            'AP': ['Cassandra', 'DynamoDB', 'CouchDB']
        };
        const names = { C: 'Consistency', A: 'Availability', P: 'Partition Tolerance' };

        function toggleCAP(prop) {
            if (selected.has(prop)) { selected.delete(prop); }
            else if (selected.size < 2) { selected.add(prop); }
            else { const first = selected.values().next().value; selected.delete(first); selected.add(prop); }

            document.querySelectorAll('.cap-node').forEach(n => n.classList.toggle('selected', selected.has(n.dataset.cap)));
            updateCAPInfo();
        }

        function updateCAPInfo() {
            if (selected.size < 2) {
                document.getElementById('capTitle').textContent = 'Select 2 properties';
                document.getElementById('capDesc').textContent = 'Click on two nodes to see the trade-off and real-world examples.';
                document.getElementById('capExamples').innerHTML = '';
                return;
            }
            const arr = Array.from(selected).sort();
            const key = arr.join('');
            const sacrificed = ['C', 'A', 'P'].find(p => !selected.has(p));

            document.getElementById('capTitle').textContent = arr.map(p => names[p]).join(' + ');
            document.getElementById('capDesc').innerHTML = `You sacrifice: <span style="color: var(--error); font-weight: 600;">${names[sacrificed]}</span>`;
            document.getElementById('capExamples').innerHTML = (examples[key] || []).map(ex => `<div class="cap-example">üè¢ ${ex}</div>`).join('');
        }

        let partitioned = false;
        let systemType = 'CP'; // Default

        function togglePartition() {
            partitioned = !partitioned;
            const line = document.getElementById('partitionLine');
            const behavior = document.getElementById('partitionBehavior');

            line.classList.toggle('connected', !partitioned);
            behavior.innerHTML = `
                <div style="margin-bottom: 0.5rem;">
                    <strong>System Type: </strong>
                    <select id="sysTypeSelect" onchange="systemType = this.value; updateFeedback();" 
                        style="background:var(--bg-secondary); color:var(--text-primary); border:1px solid var(--border-light); padding:0.2rem; border-radius:4px;">
                        <option value="CP">CP (Consistency)</option>
                        <option value="AP">AP (Availability)</option>
                    </select>
                </div>
                ${partitioned
                    ? '<strong>Partition Active!</strong> Click regions to simulate writes.'
                    : '<strong>No Partition.</strong> Data syncs instantly between regions.'}
            `;
            updateFeedback();
        }

        function simulateRequest(region) {
            const feedback = document.getElementById(`feedback${region}`);
            const otherRegion = region === 'A' ? 'B' : 'A';
            const otherFeedback = document.getElementById(`feedback${otherRegion}`);

            if (!partitioned) {
                feedback.innerHTML = '<span style="color:var(--success)">Write Success (Syncd)</span>';
                otherFeedback.innerHTML = '<span style="color:var(--success)">Updated</span>';
                setTimeout(() => {
                    feedback.innerHTML = 'Click to write';
                    otherFeedback.innerHTML = 'Click to write';
                }, 1500);
                return;
            }

            // Partitioned Logic
            if (systemType === 'CP') {
                if (region === 'A') {
                    feedback.innerHTML = '<span style="color:var(--success)">Write Success (Primary)</span>';
                    otherFeedback.innerHTML = '<span style="color:var(--text-muted)">Stale Data</span>';
                } else {
                    feedback.innerHTML = '<span style="color:var(--error)">Write Failed (No Quorum)</span>';
                }
            } else {
                // AP
                feedback.innerHTML = '<span style="color:var(--warning)">Write Accepted (Local)</span>';
                otherFeedback.innerHTML = '<span style="color:var(--warning)">Divergent Data</span>';
            }

            setTimeout(() => {
                if (feedback.innerText.includes('Write')) feedback.innerHTML = 'Click to write';
            }, 2000);
        }

        function updateFeedback() {
            document.getElementById('feedbackA').innerHTML = 'Click to write';
            document.getElementById('feedbackB').innerHTML = 'Click to write';
        }

        // Quiz
        function checkCAPQuizAnswer(el, correct) {
            const options = document.querySelectorAll('#capQuizOptions .quiz-option');
            options.forEach(opt => { opt.style.pointerEvents = 'none'; opt.classList.remove('correct', 'incorrect'); });
            el.classList.add(correct ? 'correct' : 'incorrect');
            if (!correct) options[1].classList.add('correct');
            const feedback = document.getElementById('capQuizFeedback');
            feedback.style.display = 'block';
            feedback.innerHTML = correct
                ? '<div class="info-box tip"><div class="info-box-title">‚úÖ Correct!</div><p>AP (Availability + Partition tolerance) allows writes during network issues. Shopping carts can tolerate eventual consistency ‚Äî users won\'t notice if their cart briefly shows different items on different servers.</p></div>'
                : '<div class="info-box warning"><div class="info-box-title">‚ùå Not quite</div><p>CP would reject writes during network partitions. For a shopping cart where availability matters more than perfect consistency, AP is the right choice (like Amazon\'s Dynamo).</p></div>';
        }
    </script>
</body>

</html>